<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Singapore Phone Detect</title>
    <link href="/css/tailwind-compiled.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>

<body class="bg-white text-gray-900">
    <!-- Navigation -->
    <nav class="border-b border-gray-100 bg-white">
        <div class="w-full max-w-7xl mx-auto px-4 md:px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="inline-flex items-center justify-center w-8 h-8 bg-black rounded-full mr-3">
                        <span class="text-white text-sm font-semibold">S</span>
                    </div>
                    <a href="/" class="text-xl font-semibold text-gray-900 tracking-tight">Singapore Phone Detect</a>
                </div>
                <div class="flex items-center space-x-6">
                    <a href="/" class="text-gray-500 hover:text-gray-900 font-medium">Home</a>
                    <a href="/file-manager" class="text-gray-500 hover:text-gray-900 font-medium">File Manager</a>
                    <div class="relative">
                        <button id="userMenuBtn"
                            class="flex items-center text-gray-500 hover:text-gray-900 font-medium">
                            <span id="userName">Profile</span>
                            <svg class="ml-1 w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd"></path>
                            </svg>
                        </button>
                        <div id="userMenu"
                            class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg border border-gray-100 shadow-sm py-1 z-50">
                            <a href="/profile"
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Profile</a>
                            <button id="logoutBtn"
                                class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Profile Hero Section -->
    <div class="bg-white border-b border-gray-100 py-12">
        <div class="w-full max-w-4xl mx-auto px-4 md:px-6">
            <div class="bg-white rounded-lg border border-gray-100 p-8">
                <div class="flex items-center space-x-6">
                    <div class="flex-shrink-0">
                        <div class="w-20 h-20 bg-black rounded-full flex items-center justify-center text-white text-2xl font-semibold"
                            id="userAvatar">
                            U
                        </div>
                    </div>
                    <div class="flex-1">
                        <h1 class="text-3xl font-semibold text-gray-900 tracking-tight mb-1" id="profileName">Loading...
                        </h1>
                        <p class="text-gray-500 mb-2" id="profileEmail">Loading...</p>
                        <div class="flex items-center space-x-4 text-sm text-gray-500">
                            <span id="profileStatus">Active</span>
                            <span>•</span>
                            <span id="profileJoinDate">Member since</span>
                        </div>
                    </div>
                    <div class="flex-shrink-0">
                        <button id="editProfileBtn"
                            class="bg-black hover:bg-gray-900 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                            Edit Profile
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Content -->
    <div class="w-full max-w-4xl mx-auto px-4 md:px-6 py-12">
        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="bg-white border border-gray-100 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Total Logins</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalLogins">0</p>
                    </div>
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M3 3a1 1 0 011 1v12a1 1 0 11-2 0V4a1 1 0 011-1zm7.707 3.293a1 1 0 010 1.414L9.414 9H17a1 1 0 110 2H9.414l1.293 1.293a1 1 0 01-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Last Login</p>
                        <p class="text-sm font-medium text-gray-900" id="lastLogin">Never</p>
                    </div>
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Successful</p>
                        <p class="text-2xl font-semibold text-gray-900" id="successfulLogins">0</p>
                    </div>
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white border border-gray-100 rounded-lg p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm mb-1">Failed</p>
                        <p class="text-2xl font-semibold text-gray-900" id="failedLogins">0</p>
                    </div>
                    <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L9.586 10 5.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Information and Login History -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Profile Information -->
            <div class="bg-white rounded-lg border border-gray-100 p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Profile Information</h2>

                <form id="profileForm" class="space-y-5">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-900 mb-2">Full Name</label>
                        <input type="text" id="name" name="name"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all"
                            readonly>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-900 mb-2">Email Address</label>
                        <input type="email" id="email" name="email"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-50" readonly>
                    </div>

                    <div>
                        <label for="device" class="block text-sm font-medium text-gray-900 mb-2">Device</label>
                        <input type="text" id="device" name="device"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all"
                            readonly>
                    </div>

                    <div>
                        <label for="location" class="block text-sm font-medium text-gray-900 mb-2">Location</label>
                        <input type="text" id="location" name="location"
                            class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all"
                            readonly>
                    </div>

                    <div id="profileFormActions" class="hidden pt-6 border-t border-gray-100">
                        <div class="flex space-x-3">
                            <button type="submit"
                                class="bg-black hover:bg-gray-900 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                                Save Changes
                            </button>
                            <button type="button" id="cancelEditBtn"
                                class="border border-gray-200 text-gray-700 px-6 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>
                </form>

                <div class="pt-6 border-t border-gray-100 mt-6">
                    <button id="changePasswordBtn" class="text-black hover:underline font-medium">
                        Change Password
                    </button>
                </div>
            </div>

            <!-- Login History -->
            <div class="bg-white rounded-lg border border-gray-100 p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">Recent Login History</h2>

                <div id="loginHistory" class="space-y-4">
                    <!-- Login history will be populated here -->
                </div>

                <div id="noLoginHistory" class="hidden text-center py-8 text-gray-500">
                    No login history available
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg border border-gray-100 p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-semibold text-gray-900 mb-6">Change Password</h3>

            <form id="passwordForm" class="space-y-5">
                <div>
                    <label for="currentPassword" class="block text-sm font-medium text-gray-900 mb-2">Current
                        Password</label>
                    <input type="password" id="currentPassword" name="currentPassword"
                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all"
                        required>
                </div>

                <div>
                    <label for="newPassword" class="block text-sm font-medium text-gray-900 mb-2">New Password</label>
                    <input type="password" id="newPassword" name="newPassword"
                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all"
                        required>
                    <p class="text-xs text-gray-500 mt-2">Minimum 8 characters with uppercase, lowercase, number, and
                        special character</p>
                </div>

                <div>
                    <label for="confirmNewPassword" class="block text-sm font-medium text-gray-900 mb-2">Confirm New
                        Password</label>
                    <input type="password" id="confirmNewPassword" name="confirmNewPassword"
                        class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all"
                        required>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="submit"
                        class="flex-1 bg-black hover:bg-gray-900 text-white py-3 rounded-lg font-medium transition-colors">
                        Change Password
                    </button>
                    <button type="button" id="cancelPasswordBtn"
                        class="flex-1 border border-gray-200 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Messages -->
    <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>

    <!-- Scripts -->
    <script src="/js/authManager.js"></script>
    <script>
        let isEditing = false;
        let originalProfileData = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function () {
            await loadProfile();
            setupEventListeners();
        });

        // Load user profile
        async function loadProfile() {
            try {
                const result = await authManager.getProfile();

                if (result.success) {
                    displayProfile(result.user);
                    displayStats(result.stats);
                    displayLoginHistory(result.loginHistory);
                } else {
                    showMessage('Failed to load profile', 'error');
                    if (result.error.includes('not authenticated')) {
                        authManager.redirectToLogin();
                    }
                }
            } catch (error) {
                console.error('Load profile error:', error);
                showMessage('Network error occurred', 'error');
            }
        }

        // Display profile information
        function displayProfile(user) {
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('userName').textContent = user.name;

            // Update avatar with first letter of name
            const avatar = document.getElementById('userAvatar');
            avatar.textContent = user.name.charAt(0).toUpperCase();

            // Profile form
            document.getElementById('name').value = user.name;
            document.getElementById('email').value = user.email;
            document.getElementById('device').value = user.device || '';
            document.getElementById('location').value = user.location || '';

            // Join date
            const joinDate = new Date(user.created_at).toLocaleDateString();
            document.getElementById('profileJoinDate').textContent = `Member since ${joinDate}`;

            // Store original data
            originalProfileData = {
                name: user.name,
                device: user.device || '',
                location: user.location || ''
            };
        }

        // Display statistics
        function displayStats(stats) {
            document.getElementById('totalLogins').textContent = stats.totalLogins;
            document.getElementById('successfulLogins').textContent = stats.successfulLogins;
            document.getElementById('failedLogins').textContent = stats.failedLogins;

            if (stats.lastLogin) {
                const lastLogin = new Date(stats.lastLogin).toLocaleDateString();
                document.getElementById('lastLogin').textContent = lastLogin;
            }
        }

        // Display login history
        function displayLoginHistory(history) {
            const container = document.getElementById('loginHistory');
            const noHistory = document.getElementById('noLoginHistory');

            if (history && history.length > 0) {
                container.innerHTML = '';
                noHistory.classList.add('hidden');

                history.forEach(login => {
                    const loginItem = document.createElement('div');
                    loginItem.className = 'flex items-center justify-between py-4 border-b border-gray-100 last:border-b-0';

                    const resultColor = login.result === 'success' ? 'text-green-600' : 'text-red-600';
                    const resultIcon = login.result === 'success' ? '✓' : '✗';

                    loginItem.innerHTML = `
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <span class="${resultColor} font-medium">${resultIcon}</span>
                                <span class="text-sm font-medium text-gray-900">${login.result === 'success' ? 'Successful' : 'Failed'} login</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                ${new Date(login.login_time).toLocaleString()}
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${login.ip_address || 'Unknown IP'}
                        </div>
                    `;

                    container.appendChild(loginItem);
                });
            } else {
                container.classList.add('hidden');
                noHistory.classList.remove('hidden');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // User menu toggle
            document.getElementById('userMenuBtn').addEventListener('click', function () {
                const menu = document.getElementById('userMenu');
                menu.classList.toggle('hidden');
            });

            // Close menu when clicking outside
            document.addEventListener('click', function (e) {
                const menu = document.getElementById('userMenu');
                const btn = document.getElementById('userMenuBtn');
                if (!menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.classList.add('hidden');
                }
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', async function () {
                await authManager.logout();
                window.location.href = '/';
            });

            // Edit profile
            document.getElementById('editProfileBtn').addEventListener('click', toggleEdit);
            document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

            // Profile form submission
            document.getElementById('profileForm').addEventListener('submit', updateProfile);

            // Change password
            document.getElementById('changePasswordBtn').addEventListener('click', openPasswordModal);
            document.getElementById('cancelPasswordBtn').addEventListener('click', closePasswordModal);
            document.getElementById('passwordForm').addEventListener('submit', changePassword);

            // Close modal when clicking outside
            document.getElementById('passwordModal').addEventListener('click', function (e) {
                if (e.target === this) {
                    closePasswordModal();
                }
            });
        }

        // Toggle edit mode
        function toggleEdit() {
            isEditing = !isEditing;
            const form = document.getElementById('profileForm');
            const actions = document.getElementById('profileFormActions');
            const editBtn = document.getElementById('editProfileBtn');

            const editableFields = ['name', 'device', 'location'];

            editableFields.forEach(field => {
                const input = document.getElementById(field);
                input.readOnly = !isEditing;
                if (isEditing) {
                    input.classList.remove('bg-gray-50');
                } else {
                    input.classList.add('bg-gray-50');
                }
            });

            if (isEditing) {
                actions.classList.remove('hidden');
                editBtn.textContent = 'Cancel';
            } else {
                actions.classList.add('hidden');
                editBtn.textContent = 'Edit Profile';
            }
        }

        // Cancel edit
        function cancelEdit() {
            // Restore original values
            document.getElementById('name').value = originalProfileData.name;
            document.getElementById('device').value = originalProfileData.device;
            document.getElementById('location').value = originalProfileData.location;

            toggleEdit();
        }

        // Update profile
        async function updateProfile(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const profileData = {
                name: formData.get('name'),
                device: formData.get('device'),
                location: formData.get('location')
            };

            try {
                const result = await authManager.updateProfile(profileData);

                if (result.success) {
                    showMessage('Profile updated successfully', 'success');
                    originalProfileData = { ...profileData };
                    displayProfile(result.user);
                    toggleEdit();
                } else {
                    showMessage(result.error || 'Failed to update profile', 'error');
                }
            } catch (error) {
                console.error('Update profile error:', error);
                showMessage('Network error occurred', 'error');
            }
        }

        // Open password modal
        function openPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('currentPassword').focus();
        }

        // Close password modal
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('passwordForm').reset();
        }

        // Change password
        async function changePassword(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const currentPassword = formData.get('currentPassword');
            const newPassword = formData.get('newPassword');
            const confirmNewPassword = formData.get('confirmNewPassword');

            if (newPassword !== confirmNewPassword) {
                showMessage('New passwords do not match', 'error');
                return;
            }

            try {
                const result = await authManager.changePassword(currentPassword, newPassword, confirmNewPassword);

                if (result.success) {
                    showMessage('Password changed successfully', 'success');
                    closePasswordModal();
                } else {
                    showMessage(result.error || 'Failed to change password', 'error');
                }
            } catch (error) {
                console.error('Change password error:', error);
                showMessage('Network error occurred', 'error');
            }
        }

        // Show message
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const messageEl = document.createElement('div');

            const bgColor = type === 'success' ? 'bg-black' : type === 'error' ? 'bg-red-600' : 'bg-gray-900';

            messageEl.className = `${bgColor} text-white px-6 py-3 rounded-lg mb-2 transform transition-all duration-300`;
            messageEl.textContent = message;

            container.appendChild(messageEl);

            setTimeout(() => {
                messageEl.style.transform = 'translateX(100%)';
                messageEl.style.opacity = '0';
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.parentNode.removeChild(messageEl);
                    }
                }, 300);
            }, 5000);
        }

        // Check authentication on page load
        window.addEventListener('authStateChange', function (e) {
            if (!e.detail.isAuthenticated) {
                authManager.redirectToLogin();
            }
        });
    </script>
</body>

</html>
