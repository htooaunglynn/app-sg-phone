<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataHub - Business Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="/js/app.js" defer></script>
</head>

<body class="bg-white text-gray-900 font-sans">
    <!-- Navigation -->
    <nav class="border-b border-gray-200 sticky top-0 bg-white/80 backdrop-blur-sm z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-black rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">D</span>
                    </div>
                    <span class="font-semibold text-lg">DataHub</span>
                </div>
                <div class="flex items-center gap-4">
                    <a href="/" class="text-gray-600 hover:text-black text-sm font-medium">Home</a>
                    <!-- <a href="/file-management" class="text-gray-600 hover:text-black text-sm font-medium">Files</a> -->
                    <div class="flex items-center gap-2">
                        <% if (user) { %>
                            <span class="text-sm text-gray-600">Hello, <%= user.name %></span>
                            <form action="/auth/logout" method="POST">
                                <button type="submit"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition">Logout</button>
                            </form>
                            <% } else { %>
                                <a href="/login" class="text-sm font-medium text-gray-700 hover:underline">Login</a>
                                <% } %>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <!-- <div class="mb-8">
            <h1 class="text-4xl font-semibold mb-2">Companies</h1>
            <p class="text-gray-600">Manage and track your business contacts</p>
        </div> -->

        <!-- Controls -->
        <div class="flex flex-col gap-4 mb-8">
            <div class="flex">
                <!-- Search Box -->
                <input type="text" id="searchInput"
                    placeholder="Search by ID, company, email, phone, website, or address..."
                    class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-black transition"
                    onkeyup="filterTable()">
            </div>


            <!-- Buttons -->
            <div class="flex gap-3 flex-wrap sm:flex-nowrap">
                <button onclick="openExcelModal()"
                    class="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-900 font-medium transition flex items-center gap-2">
                    <span>↑</span> Upload Excel
                </button>
                <button onclick="exportToExcel()"
                    class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium transition flex items-center gap-2">
                    <span>↓</span> Export Excel
                </button>
                <button onclick="exportFinishData()"
                    class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium transition flex items-center gap-2">
                    <span>↓</span> Export Finish Data
                </button>
                <button onclick="exportNoData()"
                    class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium transition flex items-center gap-2">
                    <span>↓</span> Export No Data
                </button>
                <button onclick="exportWrongNumber()"
                    class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium transition flex items-center gap-2">
                    <span>↓</span> Export Wrong Number
                </button>
                <button id="openRealExistenceBtn" onclick="openRealExistenceModal()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition flex items-center gap-2">
                    <span>✔</span> Check Real Existence
                </button>
            </div>
        </div>



        <!-- Table -->
        <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="w-full text-sm table-auto">
                <thead>
                    <tr class="border-b border-gray-200 bg-gray-50">
                        <th class="px-6 py-3 text-left font-semibold text-gray-900 whitespace-nowrap">ID</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-900 whitespace-nowrap">Phone</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-900 whitespace-nowrap">Company Name</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-900 whitespace-nowrap">Physical Address
                        </th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-900 whitespace-nowrap">Email</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-900 whitespace-nowrap">Website</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-900 whitespace-nowrap">Carrier</th>
                        <th class="px-6 py-3 text-left font-semibold text-gray-900 whitespace-nowrap">Line Type</th>
                        <!-- <th class="px-6 py-3 text-left font-semibold text-gray-900">Action</th> -->
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
            <div id="emptyState" class="text-center py-12">
                <p class="text-gray-600">No companies found. Upload an Excel file to get started.</p>
            </div>
        </div>

        <!-- Validation Legend -->
        <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h3 class="text-sm font-semibold mb-2">Phone Number Validation (All Records):</h3>
            <div class="flex flex-wrap gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-green-200 border border-green-300 rounded"></div>
                    <span>Real Existence Verified</span>
                    <span id="realExistenceCount"
                        class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-green-200 border-l-4 border-orange-500 rounded"></div>
                    <span>Verified + Duplicate</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-orange-200 border border-orange-300 rounded"></div>
                    <span>Duplicate Phone Number</span>
                    <span id="duplicateCount"
                        class="bg-orange-100 text-orange-800 px-2 py-1 rounded-full text-xs font-medium">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-red-200 border border-red-300 rounded"></div>
                    <span>Invalid Singapore Phone Number</span>
                    <span id="invalidCount"
                        class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-green-50 border border-green-300 rounded"></div>
                    <span>Valid Singapore Phone Number</span>
                    <span id="validCount"
                        class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-amber-50 border border-amber-300 rounded"></div>
                    <span>Finish Count</span>
                    <span id="finishCount"
                        class="bg-amber-100 text-amber-800 px-2 py-1 rounded-full text-xs font-medium">0</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-indigo-50 border border-indigo-200 rounded"></div>
                    <span>Not Finish Count</span>
                    <span id="notFinishCount"
                        class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs font-medium">0</span>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-200">
                <div class="flex items-center justify-between text-sm">
                    <span class="font-medium text-gray-700">Total Records in Database:</span>
                    <span id="totalCount"
                        class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium">0</span>
                </div>
            </div>
        </div>
    </main>

    <!-- Excel Upload Modal -->
    <div id="excelModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Upload Excel File</h2>
                <button onclick="closeExcelModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>

            <p class="text-gray-600 text-sm mb-4">Upload an Excel file with columns: ID, Phone, Company Name, Physical
                Address, Email, Website</p>

            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" class="hidden"
                    onchange="handleFileUpload(event)">
                <button onclick="document.getElementById('excelFile').click()"
                    class="text-black font-medium hover:underline">
                    Click to browse or drag file
                </button>
                <p id="fileName" class="text-sm text-gray-600 mt-2"></p>
            </div>

            <div class="flex gap-3">
                <button onclick="closeExcelModal()"
                    class="flex-1 px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium transition">Cancel</button>
                <button onclick="uploadExcel()"
                    class="flex-1 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-900 font-medium transition">Upload</button>
            </div>
        </div>
    </div>

    <!-- Real Existence Check Modal -->
    <div id="realExistenceModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Check Real Existence</h2>
                <button onclick="closeRealExistenceModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>
            <p class="text-gray-600 text-sm mb-4">Check real existence of phone numbers (status = 1) in a numeric_id
                range using Numverify.</p>
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">Numeric ID From</label>
                <input id="realExistenceFrom" type="number" class="w-full px-3 py-2 border border-gray-200 rounded-lg"
                    placeholder="From">
            </div>
            <div class="mb-4">
                <label class="block text-sm text-gray-600 mb-1">Numeric ID To</label>
                <input id="realExistenceTo" type="number" class="w-full px-3 py-2 border border-gray-200 rounded-lg"
                    placeholder="To">
            </div>
            <div class="flex gap-3">
                <button onclick="closeRealExistenceModal()"
                    class="flex-1 px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium transition">Cancel</button>
                <button id="realExistenceCheckBtn" onclick="checkRealExistence()"
                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium transition">Check</button>
            </div>
            <div id="realExistenceResults" class="mt-4 text-sm"></div>
        </div>
    </div>

    <!-- Edit Company Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-lg w-full p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Edit Company</h2>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">✕</button>
            </div>

            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">ID</label>
                    <input id="editId" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50"
                        readonly>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Phone</label>
                    <input id="editPhone" type="text"
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50" readonly>
                    <div class="phone-search-buttons mt-1 flex gap-2">
                        <a id="editPhoneSearchPlus65" href="#" target="_blank" rel="noopener noreferrer"
                            class="phone-search-btn plus65 text-xs text-blue-600 hover:underline">+65 search</a>
                        <a id="editPhoneSearchQuotes" href="#" target="_blank" rel="noopener noreferrer"
                            class="phone-search-btn quotes text-xs text-blue-600 hover:underline">'quotes' search</a>
                    </div>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Company Name</label>
                    <input id="editCompanyName" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg"
                        placeholder="Company Name">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Physical Address</label>
                    <input id="editPhysicalAddress" type="text"
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg" placeholder="Physical Address">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Email</label>
                    <input id="editEmail" type="email" class="w-full px-3 py-2 border border-gray-200 rounded-lg"
                        placeholder="Email">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Website</label>
                    <input id="editWebsite" type="text" class="w-full px-3 py-2 border border-gray-200 rounded-lg"
                        placeholder="Website">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()"
                    class="flex-1 px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 font-medium transition">Cancel</button>
                <button onclick="saveEdit()"
                    class="flex-1 px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-900 font-medium transition">Save</button>
            </div>
        </div>
    </div>

    <!-- Optional: add client-side scripts as needed -->
</body>

<script>
    // Apply rate-limit UI state to buttons when needed
    function applyRateLimitUI() {
        const openBtn = document.getElementById('openRealExistenceBtn');
        const checkBtn = document.getElementById('realExistenceCheckBtn');
        const rateLimited = localStorage.getItem('NV_RATE_LIMIT') === 'true';
        if (rateLimited) {
            if (openBtn) {
                openBtn.disabled = true;
                openBtn.classList.add('opacity-50', 'cursor-not-allowed');
                openBtn.title = 'Numverify rate limit reached. Try again later.';
            }
            if (checkBtn) {
                checkBtn.disabled = true;
                checkBtn.textContent = 'Rate limit reached';
                checkBtn.classList.add('opacity-50', 'cursor-not-allowed');
                checkBtn.title = 'Numverify rate limit reached. Try again later.';
            }
        }
    }
    function openRealExistenceModal() {
        document.getElementById('realExistenceModal').classList.remove('hidden');
        // If rate limit flag is set, keep buttons disabled
        applyRateLimitUI();
    }
    function closeRealExistenceModal() {
        document.getElementById('realExistenceModal').classList.add('hidden');
        document.getElementById('realExistenceResults').innerHTML = '';
    }
    async function checkRealExistence() {
        const from = document.getElementById('realExistenceFrom').value;
        const to = document.getElementById('realExistenceTo').value;
        if (!from || !to || Number(from) > Number(to)) {
            document.getElementById('realExistenceResults').innerHTML = '<span class="text-red-600">Please enter a valid range.</span>';
            return;
        }
        document.getElementById('realExistenceResults').innerHTML = '<span class="text-gray-600">Checking, please wait...</span>';
        const checkBtn = document.getElementById('realExistenceCheckBtn');
        const openBtn = document.getElementById('openRealExistenceBtn');
        const setDisabled = (btn, text, title) => {
            if (!btn) return;
            btn.disabled = true;
            if (text) btn.textContent = text;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            if (title) btn.title = title;
        };
        const setEnabled = (btn, text) => {
            if (!btn) return;
            btn.disabled = false;
            if (text) btn.textContent = text;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.title = '';
        };
        setDisabled(checkBtn, 'Checking...', 'Processing real existence checks...');
        try {
            const res = await fetch(`/api/real-existence?from=${from}&to=${to}`, { method: 'POST', credentials: 'include' });
            const data = await res.json();
            if (!data.success) {
                const errText = data.error || 'Check failed.';
                document.getElementById('realExistenceResults').innerHTML = `<span class="text-red-600">${errText}</span>`;
                // If rate limit reached, disable both buttons and persist flag
                if (data.rateLimit === true || data.errorCode === 106 || /rate[_\s-]*limit/i.test(errText)) {
                    localStorage.setItem('NV_RATE_LIMIT', 'true');
                    // Apply and persist UI disabled state
                    setDisabled(openBtn, null, 'Numverify rate limit reached. Try again later.');
                    if (openBtn) openBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    setDisabled(checkBtn, 'Rate limit reached', 'Numverify rate limit reached. Try again later.');
                    applyRateLimitUI();
                } else {
                    // Re-enable check button for other errors
                    setEnabled(checkBtn, 'Check');
                }
                return;
            }
            let html = '<table class="w-full text-xs border mt-2"><thead><tr><th class="border px-2">ID</th><th class="border px-2">Phone</th><th class="border px-2">Result</th><th class="border px-2">Carrier</th><th class="border px-2">Line Type</th></tr></thead><tbody>';
            for (const r of data.results) {
                html += `<tr><td class="border px-2">${r.id}</td><td class="border px-2">${r.phone}</td><td class="border px-2">${r.valid ? '<span class=\"text-green-600\">Valid</span>' : '<span class=\"text-red-600\">Invalid</span>'}</td><td class="border px-2">${r.carrier || ''}</td><td class="border px-2">${r.line_type || ''}</td></tr>`;
            }
            html += '</tbody></table>';
            document.getElementById('realExistenceResults').innerHTML = html;
            // Re-enable check button after success
            setEnabled(checkBtn, 'Check');
        } catch (err) {
            document.getElementById('realExistenceResults').innerHTML = `<span class="text-red-600">Error: ${err.message}</span>`;
            setEnabled(checkBtn, 'Check');
        }
    }
    // On page load, reflect any persisted rate-limit state
    document.addEventListener('DOMContentLoaded', applyRateLimitUI);
</script>

</html>
