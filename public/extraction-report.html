<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extraction Report - Singapore Phone Detect</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 15px;
        }
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .nav-button {
            background-color: #6c757d;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            text-decoration: none;
            display: inline-block;
        }
        .nav-button:hover {
            background-color: #5a6268;
            text-decoration: none;
            color: white;
        }
        .report-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .report-section h2 {
            color: #495057;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .report-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .report-item-label {
            font-weight: bold;
            color: #495057;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .report-item-value {
            font-size: 18px;
            color: #007bff;
            font-weight: bold;
        }
        .duplicate-section {
            background-color: #fff3cd;
            border-left-color: #ffc107;
        }
        .duplicate-section h2 {
            color: #856404;
            border-bottom-color: #ffc107;
        }
        .duplicate-item {
            background: white;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .duplicate-percentage {
            font-size: 24px;
            font-weight: bold;
            color: #856404;
        }
        .duplicate-explanation {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
            margin-top: 15px;
        }
        .duplicate-explanation h4 {
            color: #0c5460;
            margin-top: 0;
            margin-bottom: 10px;
        }
        .duplicate-explanation p {
            margin: 0;
            color: #0c5460;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-badge.processed {
            background-color: #28a745;
            color: white;
        }
        .status-badge.failed {
            background-color: #dc3545;
            color: white;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #dc3545;
            margin: 20px 0;
        }
        .worksheet-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .worksheet-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #28a745;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .worksheet-name {
            font-weight: bold;
            color: #495057;
            margin-bottom: 5px;
        }
        .worksheet-stats {
            font-size: 14px;
            color: #666;
        }
        .column-mapping {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .column-mapping h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .column-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .column-tag {
            background: #e7f3ff;
            color: #0c5460;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            border: 1px solid #bee5eb;
        }
        .column-tag.phone {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .column-tag.company {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
            }
            .report-grid {
                grid-template-columns: 1fr;
            }
            .header-section {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä File Processing Report</h1>
        
        <div class="header-section">
            <div>
                <h3 id="fileName" style="margin: 0; color: #495057;">Loading...</h3>
                <small id="fileDetails" style="color: #666;"></small>
            </div>
            <div>
                <a href="/file-manager" class="nav-button">‚Üê Back to File Manager</a>
                <a href="/" class="nav-button">Main Page</a>
            </div>
        </div>

        <div id="loadingMessage" class="loading">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                Loading extraction report...
            </div>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>

        <div id="reportContent" style="display: none;">
            <!-- File Information Section -->
            <div class="report-section">
                <h2>üìÑ File Information</h2>
                <div class="report-grid" id="fileInfoGrid">
                    <!-- File info will be populated here -->
                </div>
            </div>

            <!-- Duplicate Handling Section -->
            <div class="report-section duplicate-section" id="duplicateSection">
                <h2>üîç Duplicate Handling Results</h2>
                <div class="report-grid" id="duplicateGrid">
                    <!-- Duplicate info will be populated here -->
                </div>
                <div id="duplicateExplanation" class="duplicate-explanation">
                    <!-- Duplicate explanation will be populated here -->
                </div>
                <div id="duplicateDetailsList" style="margin-top: 20px;">
                    <!-- Detailed duplicate listings will be populated here -->
                </div>
            </div>

            <!-- Processing Statistics Section -->
            <div class="report-section">
                <h2>üìà Processing Statistics</h2>
                <div class="report-grid" id="processingGrid">
                    <!-- Processing stats will be populated here -->
                </div>
            </div>

            <!-- Excel-Specific Details Section -->
            <div class="report-section" id="excelSection" style="display: none;">
                <h2>üìä Excel Processing Details</h2>
                <div id="excelContent">
                    <!-- Excel-specific content will be populated here -->
                </div>
            </div>

            <!-- Troubleshooting Section -->
            <div class="report-section" id="troubleshootingSection" style="background-color: #e7f3ff; border-left-color: #17a2b8;">
                <h2 style="color: #0c5460; border-bottom-color: #17a2b8;">üîß Troubleshooting & Analysis</h2>
                <div id="troubleshootingContent">
                    <!-- Troubleshooting content will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <script>
        // Get file ID from URL
        const urlParts = window.location.pathname.split('/');
        const fileId = urlParts[urlParts.length - 1];

        // Load extraction report on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadExtractionReport();
        });

        async function loadExtractionReport() {
            try {
                const response = await fetch(`/api/extraction-report/${fileId}`);
                const data = await response.json();

                if (data.success) {
                    displayReport(data.data);
                } else {
                    showError(data.error || 'Failed to load extraction report');
                }
            } catch (error) {
                console.error('Failed to load extraction report:', error);
                showError('Failed to connect to server. Please try again.');
            }
        }

        function displayReport(reportData) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('reportContent').style.display = 'block';

            // Update file information
            document.getElementById('fileName').textContent = reportData.originalFilename;
            document.getElementById('fileDetails').textContent = 
                `File Type: ${reportData.fileType.toUpperCase()} | Status: ${reportData.processingStatus.toUpperCase()} | Processed: ${new Date(reportData.processedAt).toLocaleString()}`;

            // Populate file information
            populateFileInfo(reportData);

            // Populate duplicate handling information
            populateDuplicateInfo(reportData.duplicateHandling);

            // Populate processing statistics
            populateProcessingStats(reportData);

            // Show Excel-specific details if applicable
            if (reportData.fileType === 'excel' && reportData.excelSpecific) {
                populateExcelDetails(reportData.excelSpecific);
                document.getElementById('excelSection').style.display = 'block';
            }

            // Populate troubleshooting information
            populateTroubleshootingInfo(reportData);
        }

        function populateFileInfo(reportData) {
            const fileInfoGrid = document.getElementById('fileInfoGrid');
            fileInfoGrid.innerHTML = `
                <div class="report-item">
                    <div class="report-item-label">Original Filename</div>
                    <div class="report-item-value">${reportData.originalFilename}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">File Type</div>
                    <div class="report-item-value">${reportData.fileType.toUpperCase()}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Processing Status</div>
                    <div class="report-item-value">
                        <span class="status-badge ${reportData.processingStatus}">${reportData.processingStatus.toUpperCase()}</span>
                    </div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Records Extracted</div>
                    <div class="report-item-value">${reportData.recordsExtracted.toLocaleString()}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Upload Date</div>
                    <div class="report-item-value">${new Date(reportData.uploadTimestamp).toLocaleDateString()}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Processing Date</div>
                    <div class="report-item-value">${new Date(reportData.processedAt).toLocaleDateString()}</div>
                </div>
            `;
        }

        function populateDuplicateInfo(duplicateHandling) {
            const duplicateGrid = document.getElementById('duplicateGrid');
            const duplicateExplanation = document.getElementById('duplicateExplanation');

            if (!duplicateHandling || !duplicateHandling.enabled) {
                document.getElementById('duplicateSection').style.display = 'none';
                return;
            }

            const duplicatesSkipped = duplicateHandling.duplicatesSkipped || 0;
            const duplicatePercentage = duplicateHandling.duplicatePercentage || 0;
            const newRecordsStored = duplicateHandling.newRecordsStored || 0;

            duplicateGrid.innerHTML = `
                <div class="duplicate-item">
                    <div class="report-item-label">New Records Stored</div>
                    <div class="report-item-value" style="color: #28a745;">${newRecordsStored.toLocaleString()}</div>
                </div>
                <div class="duplicate-item">
                    <div class="report-item-label">Duplicates Found</div>
                    <div class="report-item-value" style="color: #856404;">${duplicatesSkipped.toLocaleString()}</div>
                </div>
                <div class="duplicate-item">
                    <div class="report-item-label">Duplicate Percentage</div>
                    <div class="duplicate-percentage">${duplicatePercentage}%</div>
                </div>
                <div class="duplicate-item">
                    <div class="report-item-label">Handling Status</div>
                    <div class="report-item-value">${duplicateHandling.duplicateHandlingStatus.replace('_', ' ').toUpperCase()}</div>
                </div>
            `;

            // Generate user-friendly explanation
            let explanation = '';
            let explanationTitle = '';

            if (duplicatesSkipped === 0) {
                explanationTitle = '‚úÖ No Duplicates Found';
                explanation = 'All records in this file were new and successfully added to the system. This indicates clean, unique data.';
            } else if (duplicatePercentage >= 100) {
                explanationTitle = '‚ö†Ô∏è All Records Were Duplicates';
                explanation = 'Every record in this file already existed in the system. No new data was added, which helps maintain data integrity and prevents duplicate entries.';
            } else if (duplicatePercentage >= 50) {
                explanationTitle = 'üìä High Duplicate Percentage';
                explanation = `This file contained a significant amount of duplicate data (${duplicatePercentage}%). The system automatically identified and skipped ${duplicatesSkipped.toLocaleString()} duplicate records while successfully storing ${newRecordsStored.toLocaleString()} new records. This high duplicate rate may indicate overlapping data sources.`;
            } else if (duplicatePercentage >= 10) {
                explanationTitle = 'üîç Moderate Duplicates Detected';
                explanation = `The system found and automatically handled ${duplicatesSkipped.toLocaleString()} duplicate records (${duplicatePercentage}%). This is normal for datasets with some overlap, and ${newRecordsStored.toLocaleString()} new records were successfully added to the system.`;
            } else {
                explanationTitle = '‚ú® Minimal Duplicates';
                explanation = `A small number of duplicates (${duplicatesSkipped.toLocaleString()}) were automatically detected and skipped. This low duplicate rate indicates good data quality, and ${newRecordsStored.toLocaleString()} new records were successfully processed.`;
            }

            duplicateExplanation.innerHTML = `
                <h4>${explanationTitle}</h4>
                <p>${explanation}</p>
                <p style="margin-top: 10px; font-size: 14px; font-style: italic;">
                    üí° Duplicate detection helps maintain data integrity by preventing the same phone records from being stored multiple times in the system.
                </p>
            `;

            // Show detailed duplicate listings if available
            populateDuplicateDetails(duplicateHandling);
        }

        function populateProcessingStats(reportData) {
            const processingGrid = document.getElementById('processingGrid');
            
            let processingTime = 'N/A';
            if (reportData.extractionReport && reportData.extractionReport.processingTimeMs) {
                processingTime = `${reportData.extractionReport.processingTimeMs}ms`;
            }

            processingGrid.innerHTML = `
                <div class="report-item">
                    <div class="report-item-label">Total Records Processed</div>
                    <div class="report-item-value">${reportData.recordsExtracted.toLocaleString()}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Processing Time</div>
                    <div class="report-item-value">${processingTime}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Data Quality</div>
                    <div class="report-item-value">${reportData.duplicateHandling.duplicatePercentage < 10 ? 'Excellent' : reportData.duplicateHandling.duplicatePercentage < 30 ? 'Good' : 'Needs Review'}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Processing Result</div>
                    <div class="report-item-value">${reportData.duplicateHandling.processingResult.replace('_', ' ').toUpperCase()}</div>
                </div>
            `;
        }

        function populateExcelDetails(excelSpecific) {
            const excelContent = document.getElementById('excelContent');
            
            let html = '';

            // Worksheets processed
            if (excelSpecific.worksheetsProcessed) {
                html += `
                    <div class="report-grid">
                        <div class="report-item">
                            <div class="report-item-label">Worksheets Processed</div>
                            <div class="report-item-value">${excelSpecific.worksheetsProcessed}</div>
                        </div>
                    </div>
                `;
            }

            // Column mapping information
            if (excelSpecific.columnMapping) {
                html += `
                    <div class="column-mapping">
                        <h4>üìã Column Mapping Detected</h4>
                        <div class="column-list">
                `;
                
                Object.entries(excelSpecific.columnMapping).forEach(([key, value]) => {
                    const columnClass = key.toLowerCase().includes('phone') ? 'phone' : 
                                       key.toLowerCase().includes('company') ? 'company' : '';
                    html += `<span class="column-tag ${columnClass}">${key}: ${value}</span>`;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Duplicate analysis for Excel
            if (excelSpecific.duplicateAnalysis) {
                const dupAnalysis = excelSpecific.duplicateAnalysis;
                html += `
                    <div class="report-grid">
                        <div class="duplicate-item">
                            <div class="report-item-label">Duplicates in Extraction</div>
                            <div class="report-item-value">${dupAnalysis.duplicatesFoundInExtraction || 0}</div>
                        </div>
                        <div class="duplicate-item">
                            <div class="report-item-label">Extraction Duplicate %</div>
                            <div class="duplicate-percentage">${dupAnalysis.duplicatePercentageInExtraction || 0}%</div>
                        </div>
                    </div>
                `;
            }

            excelContent.innerHTML = html;
        }

        function populateDuplicateDetails(duplicateHandling) {
            const duplicateDetailsList = document.getElementById('duplicateDetailsList');
            
            if (!duplicateHandling.duplicateIds || duplicateHandling.duplicateIds.length === 0) {
                return;
            }

            let html = `
                <div style="background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #dc3545;">
                    <h4 style="margin-top: 0; color: #721c24;">üìã Duplicate Records Found</h4>
                    <p style="color: #721c24; margin-bottom: 15px;">
                        The following ${duplicateHandling.duplicateIds.length} record(s) were identified as duplicates and skipped during processing:
                    </p>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; background: #f8d7da;">
            `;

            duplicateHandling.duplicateIds.forEach((duplicateId, index) => {
                html += `
                    <div style="padding: 5px 0; border-bottom: 1px solid #f5c6cb; font-family: monospace; font-size: 14px;">
                        <strong>ID:</strong> ${duplicateId}
                    </div>
                `;
            });

            html += `
                    </div>
                    <p style="font-size: 12px; color: #721c24; margin-top: 10px; margin-bottom: 0;">
                        These records already existed in the system and were automatically skipped to prevent duplicates.
                    </p>
                </div>
            `;

            duplicateDetailsList.innerHTML = html;
        }

        function populateTroubleshootingInfo(reportData) {
            const troubleshootingContent = document.getElementById('troubleshootingContent');
            const duplicateHandling = reportData.duplicateHandling;
            
            let html = '<div class="report-grid">';

            // Data quality assessment
            const duplicatePercentage = duplicateHandling.duplicatePercentage || 0;
            let dataQuality = 'Excellent';
            let dataQualityColor = '#28a745';
            
            if (duplicatePercentage >= 50) {
                dataQuality = 'Needs Review';
                dataQualityColor = '#dc3545';
            } else if (duplicatePercentage >= 20) {
                dataQuality = 'Fair';
                dataQualityColor = '#ffc107';
            } else if (duplicatePercentage >= 10) {
                dataQuality = 'Good';
                dataQualityColor = '#17a2b8';
            }

            html += `
                <div class="report-item" style="border-left-color: ${dataQualityColor};">
                    <div class="report-item-label">Data Quality Assessment</div>
                    <div class="report-item-value" style="color: ${dataQualityColor};">${dataQuality}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Processing Efficiency</div>
                    <div class="report-item-value">${duplicatePercentage < 10 ? 'High' : duplicatePercentage < 30 ? 'Medium' : 'Low'}</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Duplicate Detection</div>
                    <div class="report-item-value" style="color: #28a745;">‚úÖ Active</div>
                </div>
                <div class="report-item">
                    <div class="report-item-label">Data Integrity</div>
                    <div class="report-item-value" style="color: #28a745;">‚úÖ Maintained</div>
                </div>
            `;

            html += '</div>';

            // Recommendations based on duplicate analysis
            html += '<div style="margin-top: 20px; background: white; padding: 15px; border-radius: 5px; border-left: 4px solid #17a2b8;">';
            html += '<h4 style="margin-top: 0; color: #0c5460;">üí° Recommendations</h4>';
            html += '<ul style="margin: 0; padding-left: 20px; color: #0c5460;">';

            if (duplicatePercentage === 0) {
                html += '<li>Excellent data quality! No duplicates found indicates clean source data.</li>';
                html += '<li>Continue using this data source for future uploads.</li>';
            } else if (duplicatePercentage >= 50) {
                html += '<li><strong>High duplicate rate detected.</strong> Consider reviewing data sources for overlap.</li>';
                html += '<li>Check if this file has been uploaded before or contains data from multiple sources.</li>';
                html += '<li>Consider data deduplication at the source to improve processing efficiency.</li>';
            } else if (duplicatePercentage >= 20) {
                html += '<li>Moderate duplicate rate. This may indicate overlapping data sources.</li>';
                html += '<li>Review data collection processes to minimize duplicates.</li>';
                html += '<li>The system handled duplicates automatically, maintaining data integrity.</li>';
            } else {
                html += '<li>Low duplicate rate is normal and was handled automatically.</li>';
                html += '<li>Good data quality with minimal overlap.</li>';
            }

            html += '<li>Duplicate detection ensures no duplicate phone records are stored in the system.</li>';
            html += '<li>All processing was completed successfully with data integrity maintained.</li>';

            html += '</ul></div>';

            // Technical details for troubleshooting
            if (reportData.extractionReport) {
                html += '<div style="margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #6c757d;">';
                html += '<h4 style="margin-top: 0; color: #495057;">üîç Technical Details</h4>';
                html += '<div style="font-family: monospace; font-size: 12px; color: #495057;">';
                html += `<div><strong>File ID:</strong> ${reportData.fileId}</div>`;
                html += `<div><strong>Processing Status:</strong> ${reportData.processingStatus}</div>`;
                html += `<div><strong>Duplicate Handling Status:</strong> ${duplicateHandling.duplicateHandlingStatus}</div>`;
                html += `<div><strong>Records Extracted:</strong> ${reportData.recordsExtracted}</div>`;
                html += `<div><strong>New Records Stored:</strong> ${duplicateHandling.newRecordsStored}</div>`;
                html += `<div><strong>Duplicates Skipped:</strong> ${duplicateHandling.duplicatesSkipped}</div>`;
                html += '</div></div>';
            }

            troubleshootingContent.innerHTML = html;
        }

        function showError(message) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
    </script>
</body>
</html>